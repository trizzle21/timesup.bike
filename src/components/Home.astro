---
import home from '../content/home.json';

const emailPattern = /[\w.+-]+@[\w.-]+\.[A-Za-z]{2,}/g;
const supportUrl = 'https://times-up.org/support/';
const keywordLinks = [
	{
		text: 'Membership Page',
		href: supportUrl,
		attrs: { rel: 'noreferrer noopener', target: '_blank' },
	},
];

const linkifyText = (text) => {
	const segments = [];
	let cursor = 0;

	const getNextMatch = (start) => {
		let nextMatch = { index: Infinity };

		emailPattern.lastIndex = start;
		const emailMatch = emailPattern.exec(text);
		if (emailMatch) {
			nextMatch = {
				type: 'email',
				value: emailMatch[0],
				index: emailMatch.index,
				length: emailMatch[0].length,
			};
		}

		const keywordMatch = keywordLinks
			.map((item) => ({
				type: 'link',
				value: item.text,
				href: item.href,
				attrs: item.attrs,
				index: text.indexOf(item.text, start),
				length: item.text.length,
			}))
			.filter((item) => item.index !== -1)
			.sort((a, b) => a.index - b.index)[0];

		if (keywordMatch && keywordMatch.index < nextMatch.index) {
			return keywordMatch;
		}

		return nextMatch.index !== Infinity ? nextMatch : null;
	};

	while (cursor < text.length) {
		const match = getNextMatch(cursor);

		if (!match) {
			segments.push({ type: 'text', value: text.slice(cursor) });
			break;
		}

		if (match.index > cursor) {
			segments.push({ type: 'text', value: text.slice(cursor, match.index) });
		}

		segments.push(match);
		cursor = match.index + match.length;
	}

	emailPattern.lastIndex = 0;
	return segments;
};

const { hero, gallery, schedule, overview, location, join, contact } = home;
---

<section id="home" class="home">
	<div class="home-hero">
		<h1>{hero.title}</h1>
		{hero.paragraphs.map((text) => (
			<p>{text}</p>
		))}
	</div>

	<section class="gallery-section">
		<h2>{gallery.heading}</h2>
		<div class="gallery-grid">
			{gallery.images.map((image) => (
				<div class="gallery-item">
					<img src={image.src} alt={image.alt} loading="lazy" />
				</div>
			))}
		</div>
	</section>

	<div class="info-grid">
		<section id="overview" class="info-card">
			<h2>{overview.heading}</h2>
			{overview.paragraphs.map((text) => (
				<p>{text}</p>
			))}
			<img class="overview-hero" src={overview.image.src} alt={overview.image.alt} />
		</section>

		<section id="schedule" class="info-card">
			<h2>Schedule Overview</h2>
			<dl class="schedule-list">
				{schedule.map((item) => (
					<div class="schedule-item">
						<dt>{item.label}</dt>
						<dd>{item.detail}</dd>
					</div>
				))}
			</dl>
		</section>

		<section id="location" class="info-card">
			<h2>{location.heading}</h2>
			<img class="location-map" src={location.mapImage.src} alt={location.mapImage.alt} />
			<address>
				<a
					class="location-link"
					href="https://maps.app.goo.gl/yY5xKLyQZChtnrhP6"
					target="_blank"
					rel="noreferrer noopener"
				>
					{location.address.map((line, index) => (
						<>
							{line}
							{index < location.address.length - 1 && <br />}
						</>
					))}
				</a>
			</address>
			{location.paragraphs.map((text) => (
				<p>{text}</p>
			))}
		</section>

		<section id="join" class="info-card">
			<h2>{join.heading}</h2>
			{join.paragraphs.map((text) => (
				<p>
					{linkifyText(text).map((segment) => {
						if (segment.type === 'email') {
							return <a href={`mailto:${segment.value}`}>{segment.value}</a>;
						}

						if (segment.type === 'link') {
							return (
								<a href={segment.href} rel={segment.attrs?.rel} target={segment.attrs?.target}>
									{segment.value}
								</a>
							);
						}

						return segment.value;
					})}
				</p>
			))}
		</section>

		<section id="contact" class="info-card contact-card">
			<h2>{contact.heading}</h2>
			<p>{contact.intro}</p>
			<p class="contact-email">
				<a href={`mailto:${contact.email}`}>{contact.email}</a>
			</p>
		</section>
	</div>
</section>

<style>
	.home {
		padding: 80px 32px 120px;
	}

	.home-hero {
		max-width: 800px;
		margin: 0 auto 64px;
		text-align: center;
	}

	.home-hero h1 {
		font-size: 48px;
		font-weight: 700;
		margin: 0 0 20px;
		line-height: 1.15;
		letter-spacing: -0.02em;
		color: var(--text-dark);
	}

	.home-hero p {
		margin: 0 auto;
		max-width: 640px;
		font-size: 18px;
		line-height: 1.7;
		color: var(--text-gray);
	}

	.home-hero p + p {
		margin-top: 16px;
	}

	.gallery-section {
		max-width: 1100px;
		margin: 0 auto 72px;
	}

	.gallery-section h2 {
		font-size: 28px;
		font-weight: 600;
		color: var(--text-dark);
		text-align: center;
		margin: 0 0 32px;
	}

	.gallery-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(min(320px, 100%), 1fr));
		gap: 20px;
	}

	.gallery-item {
		overflow: hidden;
		border-radius: 12px;
		aspect-ratio: 4 / 3;
		background: var(--surface);
		box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
	}

	.gallery-item img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		display: block;
	}

	.info-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(min(480px, 100%), 1fr));
		gap: 24px;
		max-width: 1100px;
		margin: 0 auto;
	}

	.info-card {
		background: var(--surface);
		border-radius: 16px;
		padding: 32px;
		box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
		display: flex;
		flex-direction: column;
		gap: 16px;
		color: var(--text-gray);
	}

	.info-card h2 {
		margin: 0;
		font-size: 22px;
		font-weight: 600;
		color: var(--text-dark);
	}

	.info-card p {
		margin: 0;
		line-height: 1.7;
		font-size: 15px;
	}

	.info-card p + p {
		margin-top: 12px;
	}

	.info-card a {
		color: var(--primary);
		font-weight: 500;
		text-decoration: underline;
		text-decoration-color: rgba(184, 111, 80, 0.3);
		text-underline-offset: 2px;
		transition: text-decoration-color 0.2s ease;
	}

	.info-card a:hover,
	.info-card a:focus {
		text-decoration-color: var(--primary);
	}

	.overview-hero {
		width: 100%;
		margin: 8px 0 12px;
		border-radius: 10px;
		object-fit: cover;
		max-height: 400px;
	}

	.location-map {
		width: 100%;
		margin: 8px 0 12px;
		border-radius: 10px;
	}

	.schedule-list {
		margin: 0;
		display: flex;
		flex-direction: column;
		gap: 12px;
	}

	.schedule-item {
		display: grid;
		gap: 4px;
		padding: 16px;
		background: var(--surface-warm);
		border-radius: 10px;
		border-left: 3px solid var(--accent);
	}

	.schedule-item dt {
		font-weight: 600;
		font-size: 15px;
		color: var(--text-dark);
	}

	.schedule-item dd {
		margin: 0;
		color: var(--text-gray);
		line-height: 1.6;
		font-size: 14px;
	}

	address {
		font-style: normal;
		color: var(--text-gray);
		line-height: 1.7;
		font-size: 15px;
	}

	.location-link {
		color: var(--primary);
		text-decoration: underline;
		text-decoration-color: rgba(184, 111, 80, 0.3);
		text-underline-offset: 2px;
		font-weight: 500;
		transition: text-decoration-color 0.2s ease;
	}

	.location-link:hover,
	.location-link:focus {
		text-decoration-color: var(--primary);
	}

	.contact-card .contact-email {
		font-weight: 600;
		font-size: 18px;
	}

	@media screen and (max-width: 768px) {
		.home {
			padding: 56px 20px 80px;
		}

		.home-hero {
			margin-bottom: 48px;
		}

		.home-hero h1 {
			font-size: 32px;
		}

		.home-hero p {
			font-size: 16px;
		}

		.gallery-section {
			margin-bottom: 48px;
		}

		.gallery-section h2 {
			font-size: 22px;
			margin-bottom: 24px;
		}

		.gallery-grid {
			grid-template-columns: 1fr;
			gap: 16px;
		}

		.info-card {
			padding: 24px 20px;
		}

		.info-card h2 {
			font-size: 20px;
		}

		.schedule-item {
			padding: 14px;
		}
	}
</style>
