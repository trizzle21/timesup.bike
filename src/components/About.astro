---
import about from '../content/about.json';

const { title, storefrontImage, paragraphs, instagramUrl } = about;
const supportUrl = 'https://times-up.org/support/';

const renderParagraph = (text) => {
	const replacements = [
		{
			keyword: 'Instagram',
			href: instagramUrl,
			attrs: { rel: 'noreferrer noopener', target: '_blank' },
		},
		{
			keyword: 'Support Page',
			href: supportUrl,
			attrs: { rel: 'noreferrer noopener', target: '_blank' },
		},
	].filter((item) => item.href && text.includes(item.keyword));

	if (replacements.length === 0) {
		return text;
	}

	const segments = [];
	let cursor = 0;

	while (cursor < text.length) {
		const nextMatch = replacements
			.map((item) => ({
				...item,
				index: text.indexOf(item.keyword, cursor),
			}))
			.filter((item) => item.index !== -1)
			.sort((a, b) => a.index - b.index)[0];

		if (!nextMatch) {
			segments.push(text.slice(cursor));
			break;
		}

		if (nextMatch.index > cursor) {
			segments.push(text.slice(cursor, nextMatch.index));
		}

		segments.push({
			type: 'link',
			value: nextMatch.keyword,
			href: nextMatch.href,
			attrs: nextMatch.attrs,
		});

		cursor = nextMatch.index + nextMatch.keyword.length;
	}

	return segments;
};
---

<section id="about" class="page-section">
	<div class="content box">
		<h2>{title}</h2>
		<div class="storefront-image">
			<img src={storefrontImage.src} alt={storefrontImage.alt} />
		</div>
		{paragraphs.map((text) => {
			const content = renderParagraph(text);

				return Array.isArray(content) ? (
					<p>
						{content.map((segment) =>
							segment?.type === 'link' ? (
								<a href={segment.href} rel={segment.attrs?.rel} target={segment.attrs?.target}>
									{segment.value}
								</a>
							) : (
								segment
							)
						)}
					</p>
				) : (
					<p>{content}</p>
				);
		})}
	</div>
</section>

<style>
	#about {
		display: flex;
		justify-content: center;
		padding: 80px 32px 120px;
	}

	.content {
		max-width: 720px;
		text-align: center;
	}

	.box {
		padding: 40px 36px;
		background: var(--surface);
		border-radius: 16px;
		box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
		display: flex;
		flex-direction: column;
		gap: 20px;
	}

	h2 {
		margin: 0;
		font-size: 36px;
		font-weight: 700;
		color: var(--text-dark);
	}

	.storefront-image {
		width: 100%;
		margin: 16px 0 24px;
		border-radius: 12px;
		overflow: hidden;
	}

	.storefront-image img {
		width: 100%;
		height: auto;
		display: block;
	}

	p {
		margin: 0;
		color: var(--text-gray);
		font-size: 16px;
		line-height: 1.75;
	}

	p a {
		color: var(--primary);
		font-weight: 500;
		text-decoration: underline;
		text-decoration-color: rgba(184, 111, 80, 0.3);
		text-underline-offset: 2px;
		transition: text-decoration-color 0.2s ease;
	}

	p a:hover,
	p a:focus {
		text-decoration-color: var(--primary);
	}

	@media screen and (max-width: 768px) {
		#about {
			padding: 56px 20px 80px;
		}

		.box {
			padding: 28px 24px;
		}

		h2 {
			font-size: 28px;
		}

		p {
			font-size: 15px;
		}
	}
</style>
